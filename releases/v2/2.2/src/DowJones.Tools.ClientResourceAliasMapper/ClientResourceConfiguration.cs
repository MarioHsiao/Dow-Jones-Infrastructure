using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Xml.Linq;
using DowJones.Tools.ClientResourceAliasMapper.Mappings;

namespace DowJones.Tools.ClientResourceAliasMapper
{
    public class ClientResourceConfiguration
    {
        public List<ClientResourceAliasMapping> Aliases { get; private set; }

        public List<ClientResourceMapping> Mappings { get; private set; }

        public ClientResourceConfiguration(IEnumerable<ClientResourceMapping> resources = null, IEnumerable<ClientResourceAliasMapping> aliases = null)
        {
            Aliases = new List<ClientResourceAliasMapping>(aliases ?? Enumerable.Empty<ClientResourceAliasMapping>());
            Mappings = new List<ClientResourceMapping>(resources ?? Enumerable.Empty<ClientResourceMapping>());
        }

        public void Save(string fileName)
        {
            var document =
                new XElement("ClientResources",
                    new XElement("resources", Mappings.Select(x => (XElement)x)),
                    new XComment(GetAutoGeneratedCommentText()),
                    new XElement("aliases", Aliases.Select(x => (XElement)x))
                );

            try
            {
                document.Save(fileName);
            }
            catch (Exception ex)
            {
                throw new ApplicationException(string.Format("Error saving file {0}: {1}", fileName, ex.Message), ex);
            }
        }

        public static ClientResourceConfiguration Load(string filename)
        {
            var document = XDocument.Load(filename);

            IEnumerable<ClientResourceAliasMapping> aliases =
                document
                    .Descendants("aliases")
                    .Descendants(ClientResourceAliasMapping.XName)
                    .Select(x => (ClientResourceAliasMapping)x);

            IEnumerable<ClientResourceMapping> resourceMappings =
                document
                    .Descendants("resources")
                    .Descendants(ClientResourceMapping.XName)
                    .Select(x => (ClientResourceMapping)x);

            return new ClientResourceConfiguration(resourceMappings.ToArray(), aliases.ToArray());
        }

        private static string GetAutoGeneratedCommentText()
        {
            var text = new StringBuilder();

            text.AppendLine( "\r\n   *********  AUTO-GENERATED SECTION  ********");
            text.AppendLine( "   This section generated with the Client Resource Alias Mapper tool located at:");
            text.AppendLine(@"   \\sbkntsfap05.dowjones.net\Client_Share\DJ Infrastructure\Tools\ClientResourceAliasMapper.exe");
            text.AppendLine( "   Any manual changes will be overwritten, so please use the mapping tool to regenerate.");

            return text.ToString();
        }
    }
}
