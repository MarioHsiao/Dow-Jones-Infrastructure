<script src="../template.js"></script> 
<script>
setTargetScript('../../DowJones.Web.Mvc/Resources/js/ServiceProxy.js');
include('../../DowJones.Web.Mvc/Resources/js/ErrorManager.js');
include('https://github.com/appendto/jquery-mockjax/raw/master/jquery.mockjax.js');

$(document).ready(function () {

    module('Services.ServiceProxy');

    test('should exist', function () {
        ok(DJ.Services.PlatformServiceProxy);
    });

    test('has constructor', function () {
        ok(new DJ.Services.PlatformServiceProxy());
    });

    test('is inheritable', function () {
        var TestProxy = DJ.Services.PlatformServiceProxy.extend({
            doesThisWork: function () { return true; }
        });

        var proxy = new TestProxy();

        ok(proxy.doesThisWork());
    });

    test('should convert datetime strings in JSON to Date objects', function () {
        var jsonObj = JSON.parse('{"Offset": 100,"Records": 100,"TotalRecords": 41592,"Description": "Dow Jones Segmentation Content Service","Language": "en-US","Link": "http://api.int.dowjones.com/api/1.0/Content","PubDateTime": "/Date(1297141200000-0500)/","Title": "Dow Jones Segmentation Content Service","Copyright": "Copyright 2011, Dow Jones EMG"}');

        JSON.parseDatesInObj(jsonObj);
        ok(typeof jsonObj.PubDateTime === 'object' && jsonObj.PubDateTime.constructor == (new Date).constructor);
    });

    test('should convert datetime strings (without timezone) in JSON to Date objects', function () {
        var jsonObj = JSON.parse('{"Offset": 100,"Records": 100,"TotalRecords": 41592,"Description": "Dow Jones Segmentation Content Service","Language": "en-US","Link": "http://api.int.dowjones.com/api/1.0/Content","PubDateTime": "/Date(1297141200000)/","Title": "Dow Jones Segmentation Content Service","Copyright": "Copyright 2011, Dow Jones EMG"}');

        JSON.parseDatesInObj(jsonObj);
        ok(typeof jsonObj.PubDateTime === 'object' && jsonObj.PubDateTime.constructor == (new Date).constructor);
    });


    asyncTest('should call session timeout handler when AJAX response contains session timeout error code', 1, function () {
        var url = '/modules/data/json';

        $.mockjax({
            url: url,
            status: 500,
            responseText: '{"audit":null,"error":{"code":-2147176633,"message":"You are not currently logged in. Please log into and try again."}}'
        });

        DJ.Services.PlatformServiceProxy.SessionTimeoutHandler = function () {
            ok("The session timeout handler was called");
        };

        $dj.proxy.invoke({
            url: url,
            onComplete: start
        });
    });

});
</script>